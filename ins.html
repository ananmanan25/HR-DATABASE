<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Investor | Intelligence Suite v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
                /* Ensure link-based nav items match button styles */
a.nav-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    transition: 0.2s ease-in-out;
}

/* Specific styling for the external icon */
.nav-link .fa-external-link-alt {
    transition: transform 0.3s;
}

.nav-link:hover .fa-external-link-alt {
    transform: translate(2px, -2px);
    opacity: 1;
    color: var(--neon-green);
}
        /* --- Quantum Core Mobile Responsive Engine --- */
@media (max-width: 1024px) {
    /* 1. Layout Reset */
    body {
        flex-direction: column;
    }

    /* 2. Sidebar to Bottom HUD */
    aside {
        width: 100%;
        height: 75px;
        position: fixed;
        bottom: 0;
        left: 0;
        flex-direction: row;
        padding: 0 10px;
        border-right: none;
        border-top: 1px solid var(--border);
        background: rgba(3, 7, 18, 0.95);
        justify-content: center;
        align-items: center;
    }

    .logo-area, aside .glass-card {
        display: none; /* Hide logo and status in bottom nav */
    }

    aside nav {
        flex-direction: row !important;
        justify-content: space-around;
        width: 100%;
        margin: 0;
    }

    .nav-link {
        flex-direction: column;
        gap: 4px;
        font-size: 0.65rem;
        padding: 8px;
        margin: 0;
        width: 80px;
        text-align: center;
        justify-content: center;
    }

    .nav-link i {
        font-size: 1.2rem;
    }

    /* 3. Main Content Spacing */
    main {
        margin-left: 0;
        width: 100%;
        padding: 20px;
        padding-bottom: 100px; /* Space for Bottom HUD */
    }

    header h1 {
        font-size: 1.8rem !important;
    }

    /* 4. Grid Adjustments */
    .stats-grid {
        grid-template-columns: repeat(2, 1fr); /* 2x2 grid */
        gap: 15px;
    }

    /* Cumulative Analysis + Payout Circle Stacking */
    main > div[style*="grid-template-columns: 2.5fr 1fr"] {
        grid-template-columns: 1fr !important;
        display: flex !important;
        flex-direction: column;
    }

    /* 5. Table Data Protection */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        min-width: 700px; /* Ensure columns don't collapse */
    }

    /* 6. Form/Modal Optimization */
    #investor-modal .glass-card {
        width: 95vw !important;
        padding: 20px;
    }

    #investor-modal div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important; /* Stack form inputs */
    }

    .profile-initials {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
    }
}

/* Extra Small (Phones) */
@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr; /* 1 column grid */
    }

    header {
        flex-direction: column;
        align-items: flex-start !important;
    }

    #current-time {
        margin-top: 10px;
        font-size: 0.8rem;
    }
}
        :root {
            --bg: #030712;
            --card: rgba(17, 24, 39, 0.7);
            --border: rgba(255, 255, 255, 0.08);
            --text: #f9fafb;
            --text-dim: #9ca3af;
            --neon-green: #10b981;
            --neon-glow: rgba(16, 185, 129, 0.3);
            --accent-blue: #3b82f6;
            --gold: #fbbf24;
            --danger: #ef4444;
            --sidebar-w: 280px;
        }
#futuristicChart { cursor: zoom-in; }
        * { box-sizing: border-box; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            background-color: var(--bg);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: var(--sidebar-w);
            background: rgba(3, 7, 18, 0.9);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .logo-area {
            font-weight: 800; font-size: 1.25rem; letter-spacing: -0.5px;
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 48px; color: var(--text);
        }

        .logo-area i {
            color: var(--neon-green);
            filter: drop-shadow(0 0 8px var(--neon-glow));
        }

        .nav-link {
            display: flex; align-items: center; gap: 12px;
            padding: 12px; border-radius: 12px;
            color: var(--text-dim); text-decoration: none;
            margin-bottom: 8px; font-weight: 600; font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.05);
            color: var(--text);
        }

        /* --- MAIN CONTENT --- */
        main {
            margin-left: var(--sidebar-w);
            flex: 1; padding: 40px;
            width: calc(100% - var(--sidebar-w));
            max-width: 1400px;
        }

        .glass-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px;
            backdrop-filter: blur(16px);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px; margin-bottom: 32px;
        }

        .stat-card { 
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--accent);
        }

        .stat-card h2 { font-family: 'JetBrains Mono', monospace; font-size: 1.75rem; margin: 12px 0 4px 0; }

        /* --- TABLES --- */
        .table-container { margin-top: 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { padding: 12px 16px; text-align: left; font-size: 0.75rem; color: var(--text-dim); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        td { background: rgba(255,255,255,0.02); padding: 16px; font-size: 0.95rem; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        td:first-child { border-radius: 16px 0 0 16px; border-left: 1px solid var(--border); }
        td:last-child { border-radius: 0 16px 16px 0; border-right: 1px solid var(--border); }

        tr.clickable:hover td { background: rgba(255,255,255,0.05); cursor: pointer; border-color: rgba(255,255,255,0.2); }

        /* --- UI ELEMENTS --- */
        .btn { padding: 12px 24px; border-radius: 14px; border: none; cursor: pointer; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; font-size: 0.85rem; letter-spacing: 0.3px; }
        .btn-p { background: var(--neon-green); color: #000; box-shadow: 0 4px 14px var(--neon-glow); }
        .btn-p:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--neon-glow); }
        
        input, select, textarea { 
            background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: #fff; 
            padding: 14px; border-radius: 12px; width: 100%; outline: none; font-family: inherit; font-size: 0.9rem;
        }
        input:focus { border-color: var(--neon-green); background: rgba(0,0,0,0.4); }

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(12px); animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .progress-container { width: 100%; height: 10px; background: rgba(255,255,255,0.05); border-radius: 20px; margin: 12px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--neon-green), var(--accent-blue)); width: 0%; border-radius: 20px; }

        .profile-initials {
            width: 70px; height: 70px; background: linear-gradient(135deg, var(--neon-green), var(--accent-blue)); color: #000;
            border-radius: 22px; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: 800; transform: rotate(-5deg);
        }

        .badge { padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .badge-active { background: var(--neon-glow); color: var(--neon-green); border: 1px solid var(--neon-green); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

<aside>
    <div class="logo-area">
        <i class="fas fa-microchip"></i>
        <span>QUANTUM CORE</span>
    </div>
    
    <nav style="flex: 1;">
        <a href="#" class="nav-link active"><i class="fas fa-th-large"></i> Dashboard</a>
        <a href="#" class="nav-link" onclick="openModal('investor-modal')"><i class="fas fa-plus-circle"></i> Onboard Node</a>
        <a href="#" class="nav-link" onclick="openModal('payout-modal')"><i class="fas fa-wallet"></i> Quick Payout</a>
    </nav>

    <div class="glass-card" style="padding: 15px; border-radius: 16px;">
        <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 8px;">SYSTEM STATUS</div>
        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: 700;">
            <div style="width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 8px var(--neon-green);"></div>
            LIVE DATA FEED
        </div>
    </div>
     <a href="ins.html" target="_blank" class="nav-link" style="text-decoration: none; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 10px; padding-top: 15px;">
    <i class="fas fa-chart-line" style="color: var(--accent);"></i> 
    <span>Investor pitch</span>
    <i class="fas fa-external-link-alt" style="font-size: 0.6rem; margin-left: auto; opacity: 0.5;"></i>
</a>

<a href="DASHBOARD.HTML" target="_blank" class="nav-link" style="text-decoration: none;">
    <i class="fas fa-globe" style="color: var(--warning);"></i> 
    <span>Analizes</span>
    <i class="fas fa-external-link-alt" style="font-size: 0.6rem; margin-left: auto; opacity: 0.5;"></i>
</a>
</aside>

<main>
    <header style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
        <div>
            <h1 style="margin:0; font-size:2.5rem; font-weight:800; letter-spacing: -1px;">Command Center</h1>
            <p style="color:var(--text-dim); margin: 5px 0 0 0;">Intelligence & Capital Oversight Protocol</p>
        </div>
        <div id="current-time" style="font-family: 'JetBrains Mono'; color: var(--neon-green); font-weight: 700;"></div>
    </header>

    <div class="stats-grid">
        <div class="glass-card stat-card" style="--accent: var(--neon-green)">
            <small style="color:var(--text-dim); font-weight: 700;">ACTIVE CAPITAL</small>
            <h2 id="total-invested">Rs. 0</h2>
            <div style="font-size: 0.75rem; color: var(--neon-green);"><i class="fas fa-caret-up"></i> Live Tracking</div>
        </div>
        <div class="glass-card stat-card" style="--accent: var(--accent-blue)">
            <small style="color:var(--text-dim); font-weight: 700;">ROI COMMITMENT</small>
            <h2 id="total-investor-profit">Rs. 0</h2>
            <div style="font-size: 0.75rem; color: var(--accent-blue);"><i class="fas fa-bullseye"></i> Target Yield</div>
        </div>
        <div class="glass-card stat-card" style="--accent: var(--gold)">
            <small style="color:var(--text-dim); font-weight: 700;">ENTITY NODES</small>
            <h2 id="investor-count">0</h2>
            <div style="font-size: 0.75rem; color: var(--gold);"><i class="fas fa-network-wired"></i> Global Network</div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 2.5fr 1fr; gap:24px; margin-bottom:32px;">
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin:0; font-size: 1.1rem;">Global Capital Growth Curve</h3>
                <div class="badge badge-active">Cumulative Analysis</div>
            </div>
            <div style="height: 350px;"><canvas id="futuristicChart"></canvas></div>
        </div>
        <div class="glass-card" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; background: radial-gradient(circle at center, rgba(16, 185, 129, 0.1) 0%, transparent 70%);">
            <div style="position: relative;">
                <svg width="150" height="150" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="8"/>
                    <circle id="progress-circle" cx="50" cy="50" r="45" fill="none" stroke="var(--neon-green)" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" style="transform: rotate(-90deg); transform-origin: 50% 50%;"/>
                </svg>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <div style="font-size:1.8rem; color:var(--text); font-weight:800; font-family: 'JetBrains Mono';" id="efficiency-val">0%</div>
                </div>
            </div>
            <p style="color:var(--text-dim); font-weight: 600; margin-top: 15px;">Capital Payout Efficiency</p>
        </div>
    </div>

    <div class="glass-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h3 style="margin:0;">Asset Distribution Ledger</h3>
            <div style="position: relative; width: 300px;">
                <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-dim);"></i>
                <input type="text" id="invSearch" placeholder="Search entity, ID or product..." style="padding-left: 45px;">
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Entity Profile</th>
                        <th>Associated Asset</th>
                        <th>Principal</th>
                        <th>Target ROI</th>
                        <th>Liquidated</th>
                        <th>Auth</th>
                    </tr>
                </thead>
                <tbody id="investor-list"></tbody>
            </table>
        </div>
    </div>
</main>
<div id="chart-zoom-modal" class="modal" onclick="closeModal()">
    <div class="glass-card" style="width: 90vw; height: 80vh; position: relative;" onclick="event.stopPropagation()">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0;">System Analytics: Expanded View</h2>
            <button class="btn" onclick="closeModal()" style="background:rgba(255,255,255,0.05); color:#fff;"><i class="fas fa-times"></i></button>
        </div>
        <div style="height: calc(100% - 60px);">
            <canvas id="zoomedChart"></canvas>
        </div>
    </div>
</div>
<div id="investor-modal" class="modal">
    <div class="glass-card" style="width:700px; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top:0; letter-spacing: -1px;">Node Onboarding</h2>
        <p style="color: var(--text-dim); margin-bottom: 25px;">Initialize a new capital node in the quantum ledger.</p>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div class="input-group">
                <small style="color:var(--neon-green); font-weight:700;">IDENTIFIER</small>
                <input id="inv-index" placeholder="E.g. QNT-77" style="margin-top:5px;">
            </div>
            <div class="input-group">
                <small style="color:var(--text-dim); font-weight:700;">LEGAL NAME</small>
                <input id="inv-name" placeholder="John Doe" style="margin-top:5px;">
            </div>
            <input id="inv-email" placeholder="Email Address">
            <input id="inv-phone" placeholder="Contact Frequency/Phone">
            <input id="inv-dob" type="date">
            <select id="inv-prod" onchange="previewProfit()"></select>
            <input id="inv-amt" type="number" placeholder="Principal Amount (Rs.)" oninput="previewProfit()">
            <input id="inv-perc" type="number" value="20" placeholder="Equity Share %" oninput="previewProfit()">
            <textarea id="inv-note" placeholder="Strategic observations / Notes..." style="grid-column: span 2; height: 100px;"></textarea>
        </div>

        <div id="profit-preview" style="margin-top:20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px dashed var(--neon-green); color:var(--neon-green); font-weight: 800; display:none; text-align: center;"></div>

        <div style="margin-top:30px; display:flex; gap:12px;">
            <button class="btn btn-p" onclick="saveInvestor()" style="flex:2;">INITIALIZE PROTOCOL</button>
            <button class="btn" onclick="closeModal()" style="background:rgba(255,255,255,0.05); color:#fff; flex:1;">ABORT</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="glass-card" style="width:550px;">
        <div style="display:flex; align-items:center; gap:25px; margin-bottom:30px;">
            <div class="profile-initials" id="prof-initials">?</div>
            <div>
                <h2 id="prof-name" style="margin:0; font-size: 1.8rem;">---</h2>
                <div id="prof-id" style="color:var(--neon-green); font-family: 'JetBrains Mono'; font-weight: 700; font-size: 0.9rem;">ID-000</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:25px;">
            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px;">
                <small style="color:var(--text-dim)">PRINCIPAL</small>
                <div id="prof-principal" style="font-weight:800; font-family: 'JetBrains Mono';">Rs. 0</div>
            </div>
            <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px;">
                <small style="color:var(--text-dim)">EQUITY SHARE</small>
                <div id="prof-equity" style="font-weight:800; font-family: 'JetBrains Mono'; color: var(--accent-blue);">0%</div>
            </div>
        </div>

        <div class="progress-container"><div id="prof-progress-bar" class="progress-bar"></div></div>
        <p id="prof-perc-label" style="font-size: 0.85rem; margin-bottom:25px; text-align: right; color: var(--neon-green); font-weight: 700;">0% Paid</p>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="glass-card" style="padding:15px; border-color: var(--border); background: none;"><small>LIABILITY</small><div id="prof-due" style="font-weight:800; font-size: 1.1rem;">0</div></div>
            <div class="glass-card" style="padding:15px; border-color: var(--gold); background: none;"><small>SETTLED</small><div id="prof-paid" style="font-weight:800; color:var(--gold); font-size: 1.1rem;">0</div></div>
        </div>
        
        <button class="btn" onclick="closeModal()" style="width:100%; margin-top:25px; background:rgba(255,255,255,0.05); color:#fff; justify-content:center;">RETURN TO COMMAND</button>
    </div>
</div>

<div id="payout-modal" class="modal">
    <div class="glass-card" style="width:400px; border-top: 4px solid var(--gold);">
        <h2 style="margin-top:0;">Record Settlement</h2>
        <p style="color: var(--text-dim); font-size: 0.9rem;">Select entity and enter liquidation amount.</p>
        <select id="pay-inv-select" style="margin-bottom:15px;"></select>
        <input id="pay-amt-main" type="number" placeholder="Settlement Amount (Rs.)">
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn" onclick="processGlobalPayout()" style="background:var(--gold); color:#000; flex:1;">CONFIRM PAYOUT</button>
            <button class="btn" onclick="closeModal()" style="background:rgba(255,255,255,0.05); color:#fff;">CANCEL</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
let zoomedChartInstance = null;
    const firebaseConfig = {
        apiKey: "AIzaSyA3xSzrOvFFMkPDtxfKQRPBwXfpa2sejKg",
        authDomain: "accountent-a4317.firebaseapp.com",
        projectId: "accountent-a4317",
        storageBucket: "accountent-a4317.firebasestorage.app",
        messagingSenderId: "708334116507",
        appId: "1:708334116507:web:3028235fb8e68f26a5f03e",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let productsArray = [];
    let investorsArray = [];
    let chartInstance = null;

    setInterval(() => {
        const now = new Date();
        document.getElementById('current-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
    }, 1000);

    window.openModal = (id) => {
        const modal = document.getElementById(id);
        modal.style.display = 'flex';
    };

    window.closeModal = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');

    window.removeItem = async (col, id) => { 
        if(confirm("Are you sure you want to terminate this data node? This action is irreversible.")) {
            await deleteDoc(doc(db, col, id)); 
        }
    };

    window.previewProfit = () => {
        const amt = Number(document.getElementById('inv-amt').value);
        const perc = Number(document.getElementById('inv-perc').value);
        const box = document.getElementById('profit-preview');
        if(amt > 0) {
            box.style.display = 'block';
            box.innerHTML = `<i class="fas fa-chart-line"></i> PROJECTED YIELD: Rs. ${(amt * (perc/100)).toLocaleString()}`;
        } else {
            box.style.display = 'none';
        }
    };

    window.saveInvestor = async () => {
        const pId = document.getElementById('inv-prod').value;
        const prod = productsArray.find(p => p.id === pId);
        
        const data = {
            indexNumber: document.getElementById('inv-index').value || 'N/A',
            name: document.getElementById('inv-name').value || 'Unnamed Entity',
            email: document.getElementById('inv-email').value,
            phone: document.getElementById('inv-phone').value,
            dob: document.getElementById('inv-dob').value,
            note: document.getElementById('inv-note').value,
            productId: pId,
            productName: prod ? prod.name : 'Direct Capital',
            amount: Number(document.getElementById('inv-amt').value),
            equity: Number(document.getElementById('inv-perc').value),
            totalPaid: 0,
            timestamp: Date.now()
        };
        
        try {
            await addDoc(collection(db, "investors"), data);
            closeModal();
            document.querySelectorAll('#investor-modal input, #investor-modal textarea').forEach(i => i.value = '');
        } catch (e) {
            alert("System Error: " + e.message);
        }
    };

    window.processGlobalPayout = async () => {
        const invId = document.getElementById('pay-inv-select').value;
        const amt = Number(document.getElementById('pay-amt-main').value);
        const inv = investorsArray.find(x => x.id === invId);
        if(inv && amt > 0) {
            await updateDoc(doc(db, "investors", invId), { totalPaid: (inv.totalPaid || 0) + amt });
            closeModal();
            document.getElementById('pay-amt-main').value = '';
        }
    };

    window.viewProfile = (id) => {
        const inv = investorsArray.find(x => x.id === id);
        if(!inv) return;

        const projected = (inv.amount * (inv.equity / 100));
        const paid = inv.totalPaid || 0;
        const progress = projected > 0 ? (paid / projected) * 100 : 0;
        
        document.getElementById('prof-initials').innerText = inv.name.charAt(0);
        document.getElementById('prof-name').innerText = inv.name;
        document.getElementById('prof-id').innerText = inv.indexNumber;
        document.getElementById('prof-principal').innerText = "Rs. " + inv.amount.toLocaleString();
        document.getElementById('prof-equity').innerText = inv.equity + "%";
        
        document.getElementById('prof-due').innerText = "Rs. " + projected.toLocaleString();
        document.getElementById('prof-paid').innerText = "Rs. " + paid.toLocaleString();
        document.getElementById('prof-progress-bar').style.width = `${Math.min(progress, 100)}%`;
        document.getElementById('prof-perc-label').innerText = `${Math.round(progress)}% Liquidation Complete`;
        
        openModal('profile-modal');
    };

    // --- UPGRADED CUMULATIVE CURVE CHART ---
    const updateChart = (data) => {
        const ctx = document.getElementById('futuristicChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        // Sort investors by timestamp to show growth over time
        const sorted = [...data].sort((a,b) => a.timestamp - b.timestamp);

        let runningTotalPrincipal = 0;
        let runningTotalYield = 0;
        
        const cumulativePrincipal = [];
        const cumulativeYield = [];
        const labels = [];

        sorted.forEach(inv => {
            runningTotalPrincipal += inv.amount;
            runningTotalYield += (inv.amount * (inv.equity / 100));
            
            cumulativePrincipal.push(runningTotalPrincipal);
            cumulativeYield.push(runningTotalYield);
            
            // Label with date or investor name sequence
            const date = new Date(inv.timestamp).toLocaleDateString([], {month: 'short', day: 'numeric'});
            labels.push(date + " (" + inv.name.split(' ')[0] + ")");
        });

        const blueGrad = ctx.createLinearGradient(0, 0, 0, 400);
        blueGrad.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
        blueGrad.addColorStop(1, 'rgba(59, 130, 246, 0)');

        const greenGrad = ctx.createLinearGradient(0, 0, 0, 400);
        greenGrad.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
        greenGrad.addColorStop(1, 'rgba(16, 185, 129, 0)');

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Principal Invested',
                        data: cumulativePrincipal,
                        borderColor: '#3b82f6',
                        backgroundColor: blueGrad,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#3b82f6'
                    },
                    {
                        label: 'Total Yield Commitment',
                        data: cumulativeYield,
                        borderColor: '#10b981',
                        backgroundColor: greenGrad,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981'
                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { 
                        display: true,
                        labels: { color: '#9ca3af', font: { family: 'JetBrains Mono', size: 10 } }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(3, 7, 18, 0.9)',
                        titleFont: { family: 'Plus Jakarta Sans', weight: 'bold' },
                        bodyFont: { family: 'JetBrains Mono' },
                        callbacks: {
                            label: (context) => context.dataset.label + ": Rs. " + context.raw.toLocaleString()
                        }
                    }
                },
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.03)' }, 
                        ticks: { color: '#9ca3af', font: { family: 'JetBrains Mono', size: 10 }, callback: (v) => 'Rs.' + v.toLocaleString() } 
                    },
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#9ca3af', font: { size: 9 } } 
                    }
                }
            }
        });
    };

    onSnapshot(collection(db, "products"), (snap) => {
        const sel = document.getElementById('inv-prod');
        sel.innerHTML = `<option value="">Select Asset Class...</option>`;
        productsArray = [];
        snap.forEach(d => {
            const p = d.data(); p.id = d.id;
            productsArray.push(p);
            sel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
    });

    onSnapshot(collection(db, "investors"), (snap) => {
        const list = document.getElementById('investor-list');
        const paySel = document.getElementById('pay-inv-select');
        list.innerHTML = "";
        paySel.innerHTML = `<option value="">Select Entity...</option>`;
        investorsArray = [];
        let cap = 0, prof = 0, totalPaid = 0;

        snap.forEach(d => {
            const inv = d.data(); inv.id = d.id;
            investorsArray.push(inv);
            paySel.innerHTML += `<option value="${inv.id}">${inv.name}</option>`;
            
            const exp = inv.amount * (inv.equity / 100);
            cap += inv.amount; prof += exp; totalPaid += (inv.totalPaid || 0);

            list.innerHTML += `
                <tr class="clickable">
                    <td onclick="viewProfile('${inv.id}')">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="width:35px; height:35px; border-radius:10px; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; font-weight:800; color:var(--neon-green);">${inv.name.charAt(0)}</div>
                            <div><b>${inv.name}</b><br><small style="color:var(--text-dim); font-family: 'JetBrains Mono';">${inv.indexNumber}</small></div>
                        </div>
                    </td>
                    <td><span class="badge" style="background:rgba(59, 130, 246, 0.1); color:var(--accent-blue);">${inv.productName}</span></td>
                    <td style="font-family: 'JetBrains Mono';">Rs. ${inv.amount.toLocaleString()}</td>
                    <td style="color:var(--neon-green); font-family: 'JetBrains Mono';">Rs. ${exp.toLocaleString()}</td>
                    <td style="color:var(--gold); font-family: 'JetBrains Mono';">Rs. ${(inv.totalPaid || 0).toLocaleString()}</td>
                    <td>
                        <div style="display:flex; gap:10px;">
                            <button onclick="viewProfile('${inv.id}')" style="background:none; border:none; color:var(--text-dim); cursor:pointer;"><i class="fas fa-eye"></i></button>
                            <button onclick="removeItem('investors','${inv.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
        });

        document.getElementById('total-invested').innerText = "Rs. " + cap.toLocaleString();
        document.getElementById('total-investor-profit').innerText = "Rs. " + prof.toLocaleString();
        document.getElementById('investor-count').innerText = snap.size;
        
        const efficiency = prof > 0 ? Math.round((totalPaid / prof) * 100) : 0;
        document.getElementById('efficiency-val').innerText = efficiency + "%";
        const offset = 283 - (283 * Math.min(efficiency, 100)) / 100;
        document.getElementById('progress-circle').style.strokeDashoffset = offset;

        if(investorsArray.length > 0) updateChart(investorsArray);
    });

    document.getElementById('invSearch').addEventListener('keyup', (e) => {
        const val = e.target.value.toLowerCase();
        document.querySelectorAll('#investor-list tr').forEach(r => {
            r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    });
// Inside your existing script, add this:
document.getElementById('futuristicChart').onclick = () => zoomChart();

window.zoomChart = () => {
    openModal('chart-zoom-modal');
    const ctx = document.getElementById('zoomedChart').getContext('2d');
    
    if (zoomedChartInstance) zoomedChartInstance.destroy();

    // We copy the data and options from the main chart
    // But we can make the fonts bigger for the large screen
    const bigOptions = JSON.parse(JSON.stringify(chartInstance.options));
    bigOptions.plugins.legend.labels.font.size = 14;
    bigOptions.scales.y.ticks.font.size = 12;
    
    zoomedChartInstance = new Chart(ctx, {
        type: 'line',
        data: chartInstance.data,
        options: bigOptions
    });
};
</script>
</body>
</html>