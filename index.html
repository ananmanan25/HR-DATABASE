<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ananmanan | Quantum Intelligence v2.1</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        #login-overlay input {
    text-align: center;
    letter-spacing: 2px;
}

#login-overlay .btn-p {
    margin-top: 10px;
}
        /* Ensure link-based nav items match button styles */
a.nav-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    transition: 0.2s ease-in-out;
}

/* Specific styling for the external icon */
.nav-link .fa-external-link-alt {
    transition: transform 0.3s;
}

.nav-link:hover .fa-external-link-alt {
    transform: translate(2px, -2px);
    opacity: 1;
    color: var(--neon-green);
}
        :root {
            --neon-green: #38f838; --dark-bg: #05070a; --card-bg: #111418;
            --text-main: #e6edf3; --text-dim: #8b949e; --danger: #ff4d4d;
            --success: #238636; --border: #30363d; --warning: #ffa500;
            --accent: #58a6ff;
        }
        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; transition: all 0.25s ease; }
        body { background: var(--dark-bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Upgrade */
        aside { width: 260px; background: #010409; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem; z-index: 100; }
        .nav-link { padding: 12px; color: var(--text-dim); border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; background: none; text-align: left; display: flex; align-items: center; gap: 12px; font-size: 0.9rem; width: 100%; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-link.active { background: var(--neon-green); color: #000; font-weight: 800; box-shadow: 0 0 15px rgba(56, 248, 56, 0.3); }

        main { flex: 1; overflow-y: auto; padding: 2rem; background: radial-gradient(circle at 50% 0%, #0d1117, #05070a); }
        .page-section { display: none; }
        .page-section.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modern Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.2rem; margin-bottom: 2rem; }
        .stat-card { background: var(--card-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--accent); opacity: 0.5; }
        .stat-card.profit::after { background: var(--neon-green); }
        .stat-card h4 { margin: 0; font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .val { font-size: 1.6rem; font-weight: 800; margin-top: 10px; font-family: 'JetBrains Mono', monospace; }
        .trend { font-size: 0.75rem; margin-top: 5px; font-weight: 600; }

        .glass-card { background: rgba(22, 27, 34, 0.7); backdrop-filter: blur(12px); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-dim); font-size: 0.75rem; border-bottom: 1px solid var(--border); text-transform: uppercase; }
        td { padding: 14px 12px; border-bottom: 1px solid rgba(48, 54, 61, 0.5); font-size: 0.85rem; }
        tr:hover { background: rgba(255,255,255,0.02); }

        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; background: #21262d; border: 1px solid var(--border); font-weight: 600; }
        .tag-low { border-color: var(--danger); color: var(--danger); }
        
        .btn { border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-p { background: var(--neon-green); color: #000; }
        .btn-p:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(56, 248, 56, 0.4); }
        .btn-d { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-d:hover { background: var(--danger); color: #fff; }
        
        input, select, textarea { background: #0d1117; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; outline: none; }
        input:focus, textarea:focus { border-color: var(--neon-green); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; }

        @keyframes scan { 0% { left: -100%; } 100% { left: 100%; } }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }
        
        #currency-toggle:checked ~ .toggle-rail { background: rgba(56, 248, 56, 0.1); border-color: var(--neon-green); }
        #currency-toggle:checked ~ .toggle-thumb { transform: translateX(22px); background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        @media (max-width: 1024px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
    /* --- Mobile Responsive Overrides --- */
/* --- Accurate Mobile UX Transformation --- */
@media (max-width: 768px) {
    /* 1. Layout Adjustment */
    body {
        flex-direction: column;
        overflow: auto;
        height: auto;
    }

    /* 2. Transform Sidebar into a Bottom Nav */
    aside {
        width: 100%;
        height: 65px;
        position: fixed;
        bottom: 0;
        left: 0;
        flex-direction: row;
        padding: 0 10px;
        background: rgba(1, 4, 9, 0.95);
        backdrop-filter: blur(10px);
        border-right: none;
        border-top: 1px solid var(--border);
        justify-content: space-around;
        z-index: 1000;
    }

    aside div:first-child, /* Logo */
    aside div:last-child { /* Exchange info */
        display: none; 
    }

    aside nav {
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: space-around;
        gap: 0;
    }

    .nav-link {
        flex-direction: column;
        gap: 4px;
        padding: 8px 0;
        font-size: 0.6rem;
        border: none;
        background: transparent;
        align-items: center;
        width: 60px;
        color: var(--text-dim);
    }

    .nav-link i {
        font-size: 1.2rem;
    }

    .nav-link.active {
        background: transparent;
        color: var(--neon-green);
        box-shadow: none;
    }

    /* 3. Main Content Spacing */
    main {
        padding: 1rem;
        padding-bottom: 80px; /* Space for bottom nav */
        overflow-y: visible;
    }

    /* 4. Stats Grid Accuracy */
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .stat-card {
        padding: 1rem;
    }

    .stat-card .val {
        font-size: 1.2rem;
    }

    /* 5. Handle Table Overflows */
    .glass-card {
        padding: 1rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
    }

    table {
        font-size: 0.75rem;
        min-width: 500px; /* Prevents squishing */
    }

    /* 6. Dashboard Grid Stacking */
    #dashboard > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }

    /* 7. Modal Full-Width for Mobile */
    .modal .glass-card {
        width: 95% !important;
        margin: 10px;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Fix for News Hub Grid */
    #news-hub > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
}

/* Extra Small (375px and below) */
@media (max-width: 400px) {
    .nav-link span {
        display: none; /* Icon only for very small screens */
    }
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
<div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--dark-bg); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <div class="glass-card" style="width:320px; text-align:center; border-top: 4px solid var(--neon-green);">
        <div style="font-size: 1.5rem; font-weight: 900; color: var(--neon-green); margin-bottom: 1rem; letter-spacing: -1px;">ANANMANAN <span style="font-size:0.6rem; vertical-align: top; color: var(--accent);">Q-INTEL</span></div>
        <p style="color:var(--text-dim); font-size:0.8rem; margin-bottom:20px;">AUTHORIZATION REQUIRED</p>
        
        <input type="text" id="user-name" placeholder="Username" style="margin-bottom:10px;">
        <input type="password" id="user-pass" placeholder="Security Key">
        
        <button class="btn btn-p" onclick="checkAuth()" style="width:100%; justify-content:center;">INITIALIZE LINK</button>
        <p id="login-err" style="color:var(--danger); font-size:0.7rem; margin-top:10px; display:none;">ACCESS DENIED: INVALID KEY</p>
    </div>
</div>

<div id="welcome-toast" style="position:fixed; top:20px; right:20px; background:var(--card-bg); border:1px solid var(--neon-green); padding:15px 25px; border-radius:12px; z-index:9000; display:none; animation: slideIn 0.5s ease;">
    <span id="display-user" style="color:var(--neon-green); font-weight:bold;"></span>, Welcome to Nexus.
</div>
<aside>
    <div style="font-size: 1.6rem; font-weight: 900; color: var(--neon-green); margin-bottom: 2rem; letter-spacing: -1px;">ANANMANAN <span style="font-size:0.6rem; vertical-align: top; color: var(--accent);">Q-INTEL</span></div>
    
    <nav style="flex: 1;">
        <button class="nav-link active" onclick="showSection('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</button>
        <button class="nav-link" onclick="showSection('inventory', this)"><i class="fas fa-microchip"></i> Stock Matrix</button>
        <button class="nav-link" onclick="showSection('sales', this)"><i class="fas fa-bolt"></i> Sales Hub</button>
        <button class="nav-link" onclick="showSection('investors', this)"><i class="fas fa-project-diagram"></i> Investors</button>
        <button class="nav-link" onclick="showSection('news-hub', this)"><i class="fas fa-bullhorn"></i> News Hub</button>
        <button class="nav-link" onclick="showSection('staff', this)"><i class="fas fa-users-cog"></i> Workforce</button>
        <button class="nav-link" onclick="showSection('expenses', this)"><i class="fas fa-wallet"></i> Ledger</button>
        <a href="ins.html" target="_blank" class="nav-link" style="text-decoration: none; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 10px; padding-top: 15px;">
    <i class="fas fa-chart-line" style="color: var(--accent);"></i> 
    <span>Investor pitch</span>
    <i class="fas fa-external-link-alt" style="font-size: 0.6rem; margin-left: auto; opacity: 0.5;"></i>
</a>

<a href="DASHBOARD.HTML" target="_blank" class="nav-link" style="text-decoration: none;">
    <i class="fas fa-globe" style="color: var(--warning);"></i> 
    <span>Analizes</span>
    <i class="fas fa-external-link-alt" style="font-size: 0.6rem; margin-left: auto; opacity: 0.5;"></i>
</a>
    </nav>

    <div style="margin-top:auto; padding: 20px; background: rgba(56, 248, 56, 0.03); border-radius: 16px; border: 1px solid rgba(56, 248, 56, 0.2); position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--neon-green), transparent); animation: scan 3s linear infinite;"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <span style="font-size: 0.65rem; color: var(--neon-green); font-weight: 900; letter-spacing: 2px; text-transform: uppercase;">Nexus Exchange</span>
            <div style="width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 10px var(--neon-green); animation: pulse 2s infinite;"></div>
        </div>
        <div id="rate-display" style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #fff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-satellite-dish" style="font-size: 0.7rem; color: var(--text-dim);"></i>
            1 USD <span style="color: var(--neon-green);">::</span> 310 LKR
        </div>
        <label class="futuristic-toggle" style="display: flex; align-items: center; cursor: pointer; gap: 12px;">
            <div style="position: relative;">
                <input type="checkbox" id="currency-toggle" onchange="updateDashboard()" style="display:none;">
                <div class="toggle-rail" style="width: 44px; height: 20px; background: #1c1f24; border: 1px solid var(--border); border-radius: 20px; transition: 0.3s;"></div>
                <div class="toggle-thumb" style="position: absolute; top: 3px; left: 4px; width: 14px; height: 14px; background: var(--text-dim); border-radius: 50%; transition: 0.3s;"></div>
            </div>
            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-dim); letter-spacing: 1px;" id="toggle-label">LOCAL LKR</span>
        </label>
    </div>
</aside>

<main>
    <div id="dashboard" class="page-section active">
        <h1 style="margin-top:0;">Executive Summary</h1>
        <div class="stats-grid">
            <div class="stat-card"><h4>Net Asset Value</h4><div class="val" id="dash-net-worth">0</div><div class="trend" style="color:var(--neon-green)">â†‘ Operational</div></div>
            <div class="stat-card"><h4>Inventory Worth</h4><div class="val" id="dash-sv" style="color:var(--warning)">0</div><div class="trend" id="low-stock-count" style="color:var(--danger)">0 items low</div></div>
            <div class="stat-card profit"><h4>Realized Margin</h4><div class="val" id="dash-profit" style="color:var(--neon-green)">0</div><div class="trend" id="profit-perc">Analytics Loading...</div></div>
            <div class="stat-card"><h4>Liquidity</h4><div class="val" id="dash-cash">0</div><div class="trend">Ready for Re-investment</div></div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:20px;">
            <div class="glass-card">
                <h3>Priority Alerts</h3>
                <div id="alerts" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
            <div class="glass-card">
                <h3>Recent Capital Injection</h3>
                <div id="cap-list" style="max-height: 200px; overflow-y:auto;"></div>
                <button class="btn btn-p" onclick="openModal('capital-modal')" style="width:100%; margin-top:15px; font-size:0.8rem;">Inject Funds</button>
            </div>
        </div>
    </div>

    <div id="news-hub" class="page-section">
        <h1>News Hub & Broadcast</h1>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div class="glass-card">
                <h3>Post New Announcement</h3>
                <input type="text" id="news-title" placeholder="Announcement Title (e.g. Dividend Payout)">
                <textarea id="news-content" rows="4" placeholder="Detailed content for investors..."></textarea>
                <button class="btn btn-p" onclick="broadcastNews()" style="width:100%"><i class="fas fa-paper-plane"></i> Broadcast to All Nodes</button>
            </div>
            <div class="glass-card">
                <h3>Live Feed History</h3>
                <div id="admin-news-list" style="max-height: 400px; overflow-y:auto;">
                    </div>
            </div>
        </div>
    </div>

    <div id="inventory" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1>Stock Matrix</h1>
            <button class="btn btn-p" onclick="openModal('add-modal')"><i class="fas fa-plus"></i> New Asset</button>
        </div>
        <div class="glass-card">
            <table>
                <thead><tr><th>Asset Name</th><th>Configuration</th><th>Unit Cost</th><th>Target Retail</th><th>Health</th><th>Action</th></tr></thead>
                <tbody id="product-list"></tbody>
            </table>
        </div>
    </div>

    <div id="investors" class="page-section">
        <h1>Investor Portfolios</h1>
        <div class="stats-grid">
            <div class="stat-card"><h4>Total Capital</h4><div class="val" id="inv-total-cap">0</div></div>
            <div class="stat-card"><h4>Total Profit Shared</h4><div class="val" id="inv-total-shared" style="color:var(--neon-green)">0</div></div>
        </div>
        <div class="glass-card">
            <table>
                <thead><tr><th>Partner</th><th>Target Product</th><th>Stake %</th><th>Investment</th><th>Current Share</th><th>Action</th></tr></thead>
                <tbody id="investor-list"></tbody>
            </table>
        </div>
    </div>

    <div id="staff" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Workforce</h1>
            <button class="btn btn-p" onclick="openModal('staff-modal')">Add Member</button>
        </div>
        <div id="staff-roster" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px; margin-top:20px;"></div>
    </div>

    <div id="sales" class="page-section">
        <h1>Sales Hub</h1>
        <button class="btn btn-p" onclick="openModal('sale-modal')" style="margin-bottom:15px;">New Transaction</button>
        <div class="glass-card">
            <table><thead><tr><th>Timestamp</th><th>Asset</th><th>Qty</th><th>Revenue</th><th>Margin</th><th>Action</th></tr></thead><tbody id="sales-list"></tbody></table>
        </div>
    </div>

    <div id="expenses" class="page-section">
        <h1>Operational Ledger</h1>
        <button class="btn btn-d" onclick="openModal('expense-modal')" style="margin-bottom:15px;">Log Outflow</button>
        <div class="glass-card">
            <table><thead><tr><th>Category</th><th>Description</th><th>Amount</th><th>Action</th></tr></thead><tbody id="expense-list"></tbody></table>
        </div>
    </div>
</main>

<div id="capital-modal" class="modal"><div class="glass-card" style="width:350px;"><h2>Capital Influx</h2><input id="cap-amt" type="number" placeholder="Amount (Rs.)"><input id="cap-note" placeholder="Source/Investor Name"><button class="btn btn-p" onclick="saveCapital()" style="width:100%">Process</button></div></div>
<div id="add-modal" class="modal"><div class="glass-card" style="width:400px;"><h2>New Asset Deployment</h2><input id="new-name" placeholder="Style/Model Name"><input id="new-variants" placeholder="Variant Config (e.g. S:10, M:5)"><input id="new-cost" type="number" placeholder="Landed Cost"><input id="new-retail" type="number" placeholder="Retail Target"><button class="btn btn-p" onclick="saveNewProduct()" style="width:100%">Sync to Cloud</button></div></div>
<div id="sale-modal" class="modal"><div class="glass-card" style="width:350px;"><h2>Finalize Sale</h2><select id="sale-prod" onchange="loadSaleVariants()"></select><select id="sale-var"></select><input id="sale-qty" type="number" value="1"><input id="sale-price" type="number" placeholder="Realized Sale Price"><button class="btn btn-p" onclick="processSale()" style="width:100%">Authorize</button></div></div>
<div id="staff-modal" class="modal"><div class="glass-card" style="width:350px;"><h2>Workforce Onboarding</h2><input id="staff-name" placeholder="Full Name"><input id="staff-role" placeholder="Core Role"><input id="staff-sal" type="number" placeholder="Base Salary"><button class="btn btn-p" onclick="saveStaff()" style="width:100%">Finalize Hire</button></div></div>
<div id="expense-modal" class="modal"><div class="glass-card" style="width:350px;"><h2>Log Outflow</h2><input id="exp-cat" placeholder="Category"><input id="exp-desc" placeholder="Description"><input id="exp-amt" type="number" placeholder="Amount"><button class="btn btn-p" onclick="saveExpense()" style="width:100%">Log Outflow</button></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, deleteDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA3xSzrOvFFMkPDtxfKQRPBwXfpa2sejKg",
        authDomain: "accountent-a4317.firebaseapp.com",
        projectId: "accountent-a4317",
        storageBucket: "accountent-a4317.firebasestorage.app",
        messagingSenderId: "708334116507",
        appId: "1:708334116507:web:3028235fb8e68f26a5f03e",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let products = [];
    let fin = { sp: 0, ex: 0, sv: 0, ls: 0, cap: 0 };
window.checkAuth = () => {
    const user = document.getElementById('user-name').value;
    const pass = document.getElementById('user-pass').value;
    const err = document.getElementById('login-err');

    if (pass === "911") {
        // Hide Login
        document.getElementById('login-overlay').style.display = 'none';
        
        // Show Welcome Message
        const toast = document.getElementById('welcome-toast');
        document.getElementById('display-user').innerText = user || "Administrator";
        toast.style.display = 'block';
        
        // Auto-hide toast after 4 seconds
        setTimeout(() => { toast.style.opacity = '0'; }, 4000);
        
        // Optional: Save session so refresh doesn't log you out immediately
        sessionStorage.setItem('q-intel-auth', 'true');
    } else {
        err.style.display = 'block';
        document.getElementById('user-pass').value = "";
    }
};

// Auto-check on load (if you want to stay logged in during the session)
window.onload = () => {
    if(sessionStorage.getItem('q-intel-auth') === 'true') {
        document.getElementById('login-overlay').style.display = 'none';
    }
};
    // UI Handlers
    window.showSection = (id, btn) => {
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active'); 
        if(btn) btn.classList.add('active');
        closeModal();
    };
    window.openModal = (id) => {
        document.getElementById(id).style.display = 'flex';
        if(id === 'sale-modal') loadDropdowns();
    };
    window.closeModal = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    window.removeItem = async (col, id) => { if(confirm("Delete record?")) await deleteDoc(doc(db, col, id)); };

    // Dashboard Update
  window.updateDashboard = () => {
    const isUSD = document.getElementById('currency-toggle').checked;
    const rate = isUSD ? 310 : 1; // Your conversion rate
    const symbol = isUSD ? "$" : "Rs. ";
    
    // Formatting function
    const format = (v) => symbol + (v / rate).toLocaleString(undefined, {maximumFractionDigits: isUSD ? 2 : 0});
    
    const cash = (fin.cap + fin.sp) - (fin.ex + fin.ls);
    const netWorth = cash + fin.sv;
    
    document.getElementById('dash-net-worth').innerText = format(netWorth);
    document.getElementById('dash-sv').innerText = format(fin.sv);
    document.getElementById('dash-profit').innerText = format(fin.sp);
    document.getElementById('dash-cash').innerText = format(cash);
    document.getElementById('toggle-label').innerText = isUSD ? "QUANTUM USD" : "LOCAL LKR";

    const profitPerc = fin.cap > 0 ? ((fin.sp / fin.cap) * 100).toFixed(1) : 0;
    document.getElementById('profit-perc').innerText = `+${profitPerc}% Return on Capital`;
};

    // NEWS BROADCAST LOGIC
    window.broadcastNews = async () => {
        const title = document.getElementById('news-title').value;
        const content = document.getElementById('news-content').value;
        
        if(!title || !content) { alert("Please fill both title and content"); return; }

        await addDoc(collection(db, "news"), {
            title: title,
            content: content,
            date: serverTimestamp()
        });

        document.getElementById('news-title').value = "";
        document.getElementById('news-content').value = "";
        alert("News broadcasted successfully!");
    };

    // NEWS FEED LISTENER (Admin View)
    onSnapshot(query(collection(db, "news"), orderBy("date", "desc"), limit(10)), (snap) => {
        let h = "";
        snap.forEach(d => {
            const n = d.data();
            h += `
                <div style="padding:12px; border-bottom:1px solid var(--border); position:relative;">
                    <div style="font-size:0.7rem; color:var(--accent); font-family:monospace;">${n.date?.toDate().toLocaleDateString() || 'POSTING...'}</div>
                    <div style="font-weight:bold; margin:4px 0;">${n.title}</div>
                    <div style="font-size:0.8rem; color:var(--text-dim);">${n.content}</div>
                    <button class="btn-d" onclick="removeItem('news', '${d.id}')" style="position:absolute; top:10px; right:10px; padding:4px 8px; font-size:0.6rem;">DELETE</button>
                </div>
            `;
        });
        document.getElementById('admin-news-list').innerHTML = h || "No broadcast history.";
    });

    // Existing Real-time Listeners
    onSnapshot(collection(db, "products"), (snap) => {
        products = []; fin.sv = 0; let h = ""; let alerts = ""; let lowCount = 0;
        snap.forEach(d => {
            const p = d.data(); p.id = d.id; products.push(p);
            fin.sv += (p.qty * p.landedCost);
            const isLow = p.qty < 5;
            if(isLow) { lowCount++; alerts += `<div class="tag tag-low">CRITICAL: ${p.name} (${p.qty})</div>`; }
            h += `<tr><td><b>${p.name}</b></td><td>${Object.entries(p.variants).map(([k,v]) => `<span class="tag">${k}:${v}</span>`).join(' ')}</td><td>${p.landedCost}</td><td>${p.retailPrice}</td><td><span class="tag" style="color:${isLow ? 'var(--danger)' : 'var(--neon-green)'}">${p.qty} Units</span></td><td><button class="btn-d" onclick="removeItem('products','${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
        });
        document.getElementById('product-list').innerHTML = h;
        document.getElementById('alerts').innerHTML = alerts || "No critical alerts.";
        document.getElementById('low-stock-count').innerText = `${lowCount} items low`;
        updateDashboard();
    });

    onSnapshot(collection(db, "investors"), (snap) => {
        let t = 0; let h = "";
        snap.forEach(d => {
            const i = d.data(); t += i.amount;
            const currentProfitShare = (fin.sp * (i.equity/100)).toFixed(0);
            h += `<tr><td><b>${i.name}</b></td><td><span class="tag">${i.productName}</span></td><td>${i.equity}%</td><td>Rs. ${i.amount.toLocaleString()}</td><td style="color:var(--neon-green)">Rs. ${Number(currentProfitShare).toLocaleString()}</td><td><button class="btn-p" style="padding:4px 8px; font-size:0.7rem;">Details</button></td></tr>`;
        });
        document.getElementById('inv-total-cap').innerText = "Rs. " + t.toLocaleString();
        document.getElementById('investor-list').innerHTML = h;
    });

    onSnapshot(collection(db, "staff"), (snap) => {
        let h = "";
        snap.forEach(d => {
            const s = d.data();
            h += `<div class="glass-card" style="border-top: 4px solid var(--neon-green);"><h3 style="margin:0;">${s.name}</h3><p style="color:var(--text-dim); margin: 5px 0 15px 0;">${s.role}</p><div style="font-family:monospace; color:var(--neon-green); font-size:1.4rem; margin-bottom:20px;">Rs. ${s.salary.toLocaleString()}</div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><button class="btn btn-p" onclick="payStaff('${s.name}', ${s.salary})">PAY</button><button class="btn btn-d" onclick="removeItem('staff','${d.id}')">OFF</button></div></div>`;
        });
        document.getElementById('staff-roster').innerHTML = h;
    });

    onSnapshot(collection(db, "capital"), snap => { let t = 0; let h = ""; snap.forEach(d => { t += d.data().amt; h += `<div style="padding:8px; border-bottom:1px solid var(--border); font-size:0.8rem;">+ Rs. ${d.data().amt.toLocaleString()} <span style="color:var(--text-dim)">(${d.data().note})</span></div>`; }); fin.cap = t; document.getElementById('cap-list').innerHTML = h; updateDashboard(); });
    onSnapshot(collection(db, "sales"), snap => { let p = 0; let h = ""; snap.forEach(d => { const s = d.data(); p += s.profit; h += `<tr><td>${s.date?.toDate().toLocaleTimeString()}</td><td>${s.name}</td><td>${s.qty}</td><td>${s.price}</td><td style="color:var(--neon-green)">+${s.profit}</td><td><button class="btn-d" onclick="removeItem('sales','${d.id}')">X</button></td></tr>`; }); fin.sp = p; document.getElementById('sales-list').innerHTML = h; updateDashboard(); });
    onSnapshot(collection(db, "expenses"), snap => { let e = 0; let h = ""; snap.forEach(d => { e += d.data().amt; h += `<tr><td>${d.data().cat}</td><td>${d.data().desc}</td><td>${d.data().amt}</td><td><button class="btn-d" onclick="removeItem('expenses','${d.id}')">X</button></td></tr>`; }); fin.ex = e; document.getElementById('expense-list').innerHTML = h; updateDashboard(); });

    // Processing Logics (Product/Sale/Staff/Capital)
    window.saveNewProduct = async () => {
        let vars = {}; let total = 0;
        document.getElementById('new-variants').value.split(',').forEach(v => { const [k,q] = v.split(':'); vars[k.trim()] = Number(q); total += Number(q); });
        await addDoc(collection(db, "products"), { name: document.getElementById('new-name').value, variants: vars, qty: total, landedCost: Number(document.getElementById('new-cost').value), retailPrice: Number(document.getElementById('new-retail').value) });
        closeModal();
    };

    window.processSale = async () => {
        const p = products.find(x => x.id === document.getElementById('sale-prod').value);
        const v = document.getElementById('sale-var').value;
        const q = Number(document.getElementById('sale-qty').value);
        const pr = Number(document.getElementById('sale-price').value);
        let newVars = {...p.variants}; newVars[v] -= q;
        await updateDoc(doc(db, "products", p.id), { variants: newVars, qty: p.qty - q });
        await addDoc(collection(db, "sales"), { name: `${p.name} (${v})`, qty: q, price: pr, profit: (pr - p.landedCost) * q, date: new Date() });
        closeModal();
    };

    window.saveStaff = async () => {
        await addDoc(collection(db, "staff"), { name: document.getElementById('staff-name').value, role: document.getElementById('staff-role').value, salary: Number(document.getElementById('staff-sal').value) });
        closeModal();
    };

    window.saveCapital = async () => { 
        await addDoc(collection(db, "capital"), { amt: Number(document.getElementById('cap-amt').value), note: document.getElementById('cap-note').value, date: new Date() }); 
        closeModal(); 
    };

    window.saveExpense = async () => {
        await addDoc(collection(db, "expenses"), { cat: document.getElementById('exp-cat').value, desc: document.getElementById('exp-desc').value, amt: Number(document.getElementById('exp-amt').value), date: new Date() });
        closeModal();
    };

    window.payStaff = async (name, salary) => {
        if(confirm(`Pay ${name} Rs. ${salary}?`)) {
            await addDoc(collection(db, "expenses"), { cat: "Payroll", desc: `Salary: ${name}`, amt: salary, date: new Date() });
        }
    };

    function loadDropdowns() {
        let opt = products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        document.getElementById('sale-prod').innerHTML = opt;
        loadSaleVariants();
    }
    window.loadSaleVariants = () => {
        const p = products.find(x => x.id === document.getElementById('sale-prod').value);
        if(p) document.getElementById('sale-var').innerHTML = Object.keys(p.variants).map(v => `<option>${v}</option>`).join('');
    };

</script>
</body>
</html>
